name: QScanner CI/CD Demo

on:
  push:
    branches:
      - master
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  qscanner:
    runs-on: ubuntu-latest

    env:
      QUALYS_ACCESS_TOKEN: ${{ secrets.QUALYS_ACCESS_TOKEN }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install GitHub CLI
      run: |
        sudo apt update
        sudo apt install -y gh

    - name: Authenticate GitHub CLI
      run: |
        echo "${{ secrets.GH_PAT }}" | gh auth login --with-token

    - name: Download QScanner
      run: |
        gh release download v4.8.0-442-dev -R mattatqualys/qscanner-binary
        chmod +x qscanner

    - name: Run QScanner repo scan
      if: github.ref == 'refs/heads/master'
      run: |
        ./qscanner --pod UK1 repo https://github.com/mattatqualys/httpbin.git --report-format sarif
        cp /home/runner/qualys/qscanner/data/*-Report.sarif.json ./qscanner-ScanResult.sarif

    - name: Build Docker image
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        docker build -t httpbin-demo:latest .

    - name: Scan Docker image
      if: startsWith(github.ref, 'refs/tags/v')
      run: |
        ./qscanner --pod UK1 image httpbin-demo:latest --report-format sarif
        cp /home/runner/qualys/qscanner/data/*-Report.sarif.json ./qscanner-DockerScan.sarif

    - name: Upload SARIF for repo scan
      if: github.ref == 'refs/heads/master'
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: ./qscanner-ScanResult.sarif

    - name: Upload SARIF for Docker scan
      if: startsWith(github.ref, 'refs/tags/v')
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: ./qscanner-DockerScan.sarif

